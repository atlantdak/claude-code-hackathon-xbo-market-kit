# 2026-02-25 — Local Crypto Icons (Session 2)

## Summary

Eliminated runtime CDN dependency by implementing a local icon system for all 205
crypto and fiat currencies. Built IconResolver (URL helper) and IconSync (cascade
download engine) with full TDD coverage. Added WP-CLI commands and WP-Cron daily sync.
After completing the 9-task plan, extended coverage by integrating CoinCap and CoinGecko
APIs plus generating custom fiat SVGs — achieving 205/205 unique icons with zero
generic placeholders.

## Completed

### Core Infrastructure (from plan)
- [x] **IconResolver** — static URL/path helper class for local icon resolution (TDD: 5 tests)
- [x] **IconSync** — cascade download engine: XBO CDN → jsDelivr → placeholder (TDD: 4 tests)
- [x] **WP-CLI `wp xbo icons sync`** command with `--force` flag
- [x] **WP-CLI `wp xbo icons status`** command for icon inventory reporting
- [x] **WP-Cron daily sync** — scheduled on plugin activation, cleared on deactivation

### Widget Wiring
- [x] **TickerShortcode** — replaced CDN URLs with `IconResolver::url()`
- [x] **MoversShortcode** — passed `iconsUrl` through JS context, removed CDN URLs

### Verification
- [x] **Initial icon sync** — downloaded 205 icons (137 from XBO CDN, 68 placeholders)
- [x] **Visual verification** — all icons render correctly, 0 console errors
- [x] **Full quality checks** — 27 tests pass, PHPCS 0 errors, PHPStan level 6 clean

### Beyond Plan — Placeholder Elimination
- [x] **CoinCap CDN integration** — replaced 25 placeholders with real PNG-in-SVG icons
- [x] **CoinGecko API integration** — replaced 30 more placeholders via markets API
- [x] **Fiat currency icons** — generated 5 custom SVGs with currency symbols (R$, Rp, RM, kr, S$) in national flag colors
- [x] **Transparency fix** — removed fallback text spans and background colors that bled through transparent SVG icons

### Final Result
- 205/205 unique icons — **0 generic placeholders remaining**

## Commits

### Feature branch (`feature/shortcode-styling`, merged via PR #16)

| Hash | Message |
|------|---------|
| `67f8a99` | feat(icons): add IconResolver for local icon URL resolution |
| `2f5d1d7` | feat(icons): add IconSync cascade download engine |
| `8200a15` | feat(icons): add WP-CLI command for icon sync |
| `315a7b7` | feat(icons): add daily WP-Cron icon sync |
| `4aded76` | refactor(icons): use local IconResolver in TickerShortcode |
| `9a6121c` | refactor(icons): use local icon path in Movers widget |
| `362ac68` | feat(icons): add 205 local crypto icon SVGs |
| `36b7af4` | fix(icons): replace 63 placeholders with real icons from CoinCap and CoinGecko |
| `36a61bf` | fix(icons): generate fiat currency icons with symbols and national colors |
| `df3e4eb` | docs: add local icons design doc and implementation plan |

### Post-merge fixes (on `main`)

| Hash | Message |
|------|---------|
| `4dfeb6d` | fix(icons): remove fallback text spans that show through transparent icons |
| `c25af4b` | fix(icons): remove fallback background color from icon containers |

## Metrics

| Metric | Value |
|--------|-------|
| Commits | 12 |
| Files created | 4 PHP classes + 2 test files + 205 SVG icons |
| Unit tests added | 9 (IconResolver: 5, IconSync: 4) |
| Total tests | 27 (all pass) |
| PHPCS errors | 0 |
| PHPStan errors | 0 |
| Icons from XBO CDN | 137 |
| Icons from CoinCap | 25 |
| Icons from CoinGecko | 30 |
| Fiat icons generated | 5 |
| Generic placeholders | 0 |

## Decisions

- **SVG-wrapped PNG** — CoinCap and CoinGecko return PNG images; embedded as base64 data URI inside SVG wrapper to keep `.svg` extension consistent across all icons
- **IconResolver / IconSync separation** — Resolver handles URL resolution at render time, Sync handles downloading at sync time. Clean single-responsibility principle.
- **Cascade download order** — XBO CDN (primary) → jsDelivr (secondary) → CoinCap → CoinGecko → generated placeholder. Each source tried in sequence until a real icon is found.
- **WP-CLI + WP-Cron dual strategy** — CLI for initial setup and manual re-sync (`wp xbo icons sync --force`), WP-Cron for daily background updates to catch new currencies
- **Icons committed to git** — No runtime CDN dependency; works offline, no external requests on page load. Trade-off: larger repo size, but icons are small SVGs.

## Architecture

```
Icon Sources (download time only):
  XBO CDN → jsDelivr → CoinCap → CoinGecko → Generated SVG
                          ↓
                    IconSync (cascade)
                          ↓
              wp-content/plugins/xbo-market-kit/assets/icons/*.svg
                          ↓
                    IconResolver::url($symbol)
                          ↓
              TickerShortcode / MoversShortcode → <img src="local.svg">

Sync Triggers:
  wp xbo icons sync     (manual, WP-CLI)
  WP-Cron daily event   (automatic, background)
```

## Next Steps

- [ ] Add icon sync progress bar to admin settings page
- [ ] Integrate icons into Orderbook and Trades widgets
- [ ] Add icon size variants (16px, 32px, 64px) for different widget contexts
- [ ] Visual regression testing with Playwright screenshots
